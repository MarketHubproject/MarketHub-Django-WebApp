{% extends 'homepage/base.html' %}

{% block title %}Recommendations for You - MarketHub{% endblock %}

{% block extra_css %}
<style>
    .recommendations-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        color: white;
        padding: 25px;
        margin-bottom: 25px;
        position: relative;
        overflow: hidden;
    }
    
    .recommendations-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
        border-radius: 50%;
    }
    
    .section-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        padding: 25px;
        margin-bottom: 30px;
        transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .section-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }
    
    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
    }
    
    .product-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
        position: relative;
    }
    
    .product-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
    }
    
    .product-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        position: relative;
    }
    
    .recommendation-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .favorite-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .favorite-btn:hover {
        background: white;
        transform: scale(1.1);
    }
    
    .product-info {
        padding: 18px;
    }
    
    .product-price {
        font-size: 1.3em;
        font-weight: bold;
        color: #e74c3c;
        margin-bottom: 8px;
    }
    
    .product-name {
        font-weight: 600;
        margin-bottom: 8px;
        color: #2c3e50;
        line-height: 1.3;
    }
    
    .product-details {
        color: #7f8c8d;
        font-size: 0.9em;
        margin-bottom: 12px;
    }
    
    .product-match {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 0.8em;
        color: #5e35b1;
        margin-bottom: 12px;
        text-align: center;
    }
    
    .product-actions {
        display: flex;
        gap: 8px;
    }
    
    .btn-view {
        flex: 1;
        background: #3498db;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        font-size: 0.9em;
        font-weight: 600;
        transition: background 0.3s;
    }
    
    .btn-view:hover {
        background: #2980b9;
        color: white;
    }
    
    .btn-message {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
        padding: 8px 10px;
        border-radius: 6px;
        font-size: 0.9em;
        transition: all 0.3s;
    }
    
    .btn-message:hover {
        background: #28a745;
        color: white;
        border-color: #28a745;
    }
    
    .categories-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .category-pill {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 500;
    }
    
    .empty-recommendations {
        text-align: center;
        padding: 60px 20px;
        color: #7f8c8d;
    }
    
    .empty-recommendations i {
        font-size: 4em;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    .refresh-btn {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        border: none;
        color: white;
        padding: 12px 25px;
        border-radius: 25px;
        font-weight: 600;
        transition: transform 0.3s;
    }
    
    .refresh-btn:hover {
        transform: translateY(-2px);
        color: white;
    }
    
    .insights-card {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        color: #d35400;
    }
    
    .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .insight-item {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
    }
    
    .insight-value {
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .section-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .section-title {
        font-size: 1.3em;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }
    
    .section-subtitle {
        color: #7f8c8d;
        font-size: 0.9em;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="recommendations-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-magic me-2"></i>Recommendations for You</h2>
                <p class="mb-0 opacity-75">Discover products tailored to your interests</p>
            </div>
            <button class="refresh-btn" onclick="refreshRecommendations()">
                <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
        </div>
    </div>
    
    {% if favorite_categories %}
    <!-- Personal Insights -->
    <div class="insights-card">
        <h5><i class="fas fa-lightbulb me-2"></i>Your Shopping Insights</h5>
        <p class="mb-0">Based on your activity, we've personalized these recommendations</p>
        <div class="insights-grid">
            <div class="insight-item">
                <div class="insight-value">{{ favorite_categories|length }}</div>
                <div>Favorite Categories</div>
            </div>
            <div class="insight-item">
                <div class="insight-value">{{ recommended_products|length }}</div>
                <div>New Suggestions</div>
            </div>
            <div class="insight-item">
                <div class="insight-value">95%</div>
                <div>Match Score</div>
            </div>
        </div>
    </div>
    
    <!-- Your Interests -->
    <div class="section-card">
        <div class="section-header">
            <div>
                <h5 class="section-title">Your Favorite Categories</h5>
                <p class="section-subtitle">Based on your browsing and favorites</p>
            </div>
        </div>
        <div class="categories-pills">
            {% for category in favorite_categories %}
                <span class="category-pill">{{ category|title }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% if recommended_products %}
    <!-- Recommended Products -->
    <div class="section-card">
        <div class="section-header">
            <div>
                <h5 class="section-title">
                    <i class="fas fa-star me-2 text-warning"></i>
                    Recommended for You
                </h5>
                <p class="section-subtitle">High-quality items that match your preferences</p>
            </div>
        </div>
        
        <div class="product-grid">
            {% for product in recommended_products %}
            <div class="product-card">
                <div class="position-relative">
                    {% if product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
                    {% else %}
                        <div class="product-image bg-light d-flex align-items-center justify-content-center">
                            <i class="fas fa-image text-muted fa-3x"></i>
                        </div>
                    {% endif %}
                    
                    <div class="recommendation-badge">
                        {% if product.avg_rating >= 4.5 %}Top Rated
                        {% elif product.review_count >= 5 %}Popular
                        {% else %}For You{% endif %}
                    </div>
                    
                    <button class="favorite-btn" onclick="toggleFavorite({{ product.id }})">
                        <i class="fas fa-heart text-muted" id="heart-{{ product.id }}"></i>
                    </button>
                </div>
                
                <div class="product-info">
                    <div class="product-price">R{{ product.price }}</div>
                    <div class="product-name">{{ product.name|truncatechars:45 }}</div>
                    <div class="product-details">
                        <i class="fas fa-map-marker-alt me-1"></i>{{ product.get_location_display }}<br>
                        <i class="fas fa-tag me-1"></i>{{ product.get_condition_display }}
                    </div>
                    
                    {% if product.avg_rating %}
                    <div class="product-match">
                        <i class="fas fa-star me-1"></i>
                        {{ product.avg_rating|floatformat:1 }} rating • {{ product.review_count }} review{{ product.review_count|pluralize }}
                    </div>
                    {% else %}
                    <div class="product-match">
                        <i class="fas fa-thumbs-up me-1"></i>
                        Perfect match for your interests
                    </div>
                    {% endif %}
                    
                    <div class="product-actions">
                        <a href="{% url 'product_detail' product.id %}" class="btn btn-view">
                            <i class="fas fa-eye me-1"></i>View
                        </a>
                        {% if product.seller != request.user %}
                        <a href="{% url 'send_message' product.id %}" class="btn btn-message" title="Contact seller">
                            <i class="fas fa-envelope"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Suggestions for Better Recommendations -->
    <div class="section-card">
        <h5 class="section-title">
            <i class="fas fa-chart-line me-2 text-info"></i>
            Improve Your Recommendations
        </h5>
        <p class="text-muted mb-3">Help us suggest better products for you:</p>
        
        <div class="row">
            <div class="col-md-4">
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <i class="fas fa-heart fa-2x text-danger"></i>
                    </div>
                    <div>
                        <strong>Add More Favorites</strong>
                        <p class="mb-0 small text-muted">Like products you're interested in</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <i class="fas fa-search fa-2x text-primary"></i>
                    </div>
                    <div>
                        <strong>Browse More Categories</strong>
                        <p class="mb-0 small text-muted">Explore different product types</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <i class="fas fa-star fa-2x text-warning"></i>
                    </div>
                    <div>
                        <strong>Rate Products</strong>
                        <p class="mb-0 small text-muted">Share your experience with others</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-3">
            <a href="{% url 'product_list' %}" class="btn btn-outline-primary me-2">
                <i class="fas fa-search me-2"></i>Browse Products
            </a>
            <a href="{% url 'advanced_search' %}" class="btn btn-outline-secondary">
                <i class="fas fa-filter me-2"></i>Advanced Search
            </a>
        </div>
    </div>
    
    {% else %}
    <!-- No Recommendations -->
    <div class="empty-recommendations">
        <i class="fas fa-robot"></i>
        <h4>Building Your Recommendations</h4>
        <p>We're learning about your preferences to suggest perfect products for you.</p>
        <p class="text-muted">Start by browsing products, adding favorites, or making searches to help us understand what you like.</p>
        
        <div class="mt-4">
            <a href="{% url 'product_list' %}" class="btn btn-primary me-3">
                <i class="fas fa-search me-2"></i>Browse Products
            </a>
            <a href="{% url 'advanced_search' %}" class="btn btn-outline-primary">
                <i class="fas fa-filter me-2"></i>Find Specific Items
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Toggle favorite functionality
function toggleFavorite(productId) {
    fetch(`/products/toggle-favorite/${productId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        const heart = document.getElementById(`heart-${productId}`);
        if (data.is_favorite) {
            heart.classList.remove('text-muted');
            heart.classList.add('text-danger');
        } else {
            heart.classList.remove('text-danger');
            heart.classList.add('text-muted');
        }
        
        // Show feedback
        const message = document.createElement('div');
        message.className = 'alert alert-success alert-dismissible fade show position-fixed';
        message.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
        message.innerHTML = `
            <i class="fas fa-${data.is_favorite ? 'heart' : 'heart-broken'} me-2"></i>
            ${data.is_favorite ? 'Added to favorites!' : 'Removed from favorites'}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(message);
        
        setTimeout(() => message.remove(), 3000);
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Refresh recommendations
function refreshRecommendations() {
    const btn = event.target.closest('button');
    const icon = btn.querySelector('i');
    
    // Add spinning animation
    icon.classList.add('fa-spin');
    btn.disabled = true;
    
    // Simulate refresh (in real app, this would make an AJAX call)
    setTimeout(() => {
        icon.classList.remove('fa-spin');
        btn.disabled = false;
        
        // Show refresh message
        const message = document.createElement('div');
        message.className = 'alert alert-info alert-dismissible fade show position-fixed';
        message.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
        message.innerHTML = `
            <i class="fas fa-sync-alt me-2"></i>
            Recommendations updated!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(message);
        
        setTimeout(() => message.remove(), 3000);
    }, 1500);
}

// Add loading states and animations
document.addEventListener('DOMContentLoaded', function() {
    // Animate cards on load
    const cards = document.querySelectorAll('.product-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>

{% endblock %}
