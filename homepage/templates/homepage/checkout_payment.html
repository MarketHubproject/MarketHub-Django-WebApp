{% extends 'homepage/base.html' %}

{% block title %}Payment - MarketHub{% endblock %}

{% load static %}

{% block extra_head %}
<script src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb bg-light rounded-pill px-4 py-2">
        <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-decoration-none"><i class="bi bi-house-fill me-1"></i>Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'view_cart' %}" class="text-decoration-none">Cart</a></li>
        <li class="breadcrumb-item"><a href="{% url 'checkout' %}" class="text-decoration-none">Checkout</a></li>
        <li class="breadcrumb-item active" aria-current="page">Payment</li>
    </ol>
</nav>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
            <!-- Header -->
            <div class="card-header border-0 text-center py-4" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                <div class="mb-3">
                    <div class="icon-circle mx-auto bg-white bg-opacity-20" style="width: 80px; height: 80px;">
                        <i class="bi bi-credit-card-fill" style="font-size: 2.5rem; color: white;"></i>
                    </div>
                </div>
                <h3 class="mb-1 fw-bold">Complete Payment</h3>
                <p class="mb-0 opacity-90">Secure payment for Order {{ order.order_number }}</p>
            </div>

            <div class="card-body p-5">
                <!-- Order Summary -->
                <div class="mb-4 p-4 bg-light rounded-3">
                    <h5 class="fw-bold mb-3"><i class="bi bi-receipt me-2"></i>Order Summary</h5>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Order Number:</span>
                        <strong>{{ order.order_number }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span>R{{ order.subtotal }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipping:</span>
                        <span>R{{ order.shipping_cost }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>Total Amount:</strong>
                        <strong class="text-success">R{{ order.total_amount }}</strong>
                    </div>
                </div>

                <!-- Payment Form -->
                <form method="POST" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label for="id_payment_method" class="form-label fw-semibold">
                            <i class="bi bi-payment-method text-success me-2"></i>Payment Method
                        </label>
                        {{ form.payment_method }}
                    </div>

                    <!-- Stripe Card Payment Fields -->
                    <div id="cardPaymentFields" style="display: none;">
                        <h5 class="fw-bold mb-3"><i class="bi bi-credit-card me-2"></i>Card Details</h5>
                        
                        <!-- Stripe Card Element -->
                        <div class="mb-3">
                            <label class="form-label">Card Information</label>
                            <div id="card-element" class="form-control" style="padding: 10px; height: auto; min-height: 40px;">
                                <!-- Stripe Elements will create form elements here -->
                            </div>
                            <div id="card-errors" role="alert" class="text-danger mt-2" style="display: none;"></div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" id="save_payment_method" class="form-check-input">
                                <label class="form-check-label" for="save_payment_method">
                                    Save this payment method for future purchases
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Security Notice -->
                    <div class="alert alert-info rounded-3 mb-4">
                        <i class="bi bi-shield-check me-2"></i>
                        <strong>Secure Payment:</strong> Your payment information is encrypted and secure. We never store your card details.
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'checkout' %}" class="btn btn-outline-secondary btn-lg rounded-pill px-4">
                            <i class="bi bi-arrow-left me-2"></i>Back to Checkout
                        </a>
                        <button type="submit" class="btn btn-success btn-lg rounded-pill px-4" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none;">
                            <i class="bi bi-lock-fill me-2"></i>Complete Payment
                        </button>
                    </div>
                </form>
            </div>

            <!-- Footer -->
            <div class="card-footer border-0 bg-light text-center py-3">
                <small class="text-muted">
                    <i class="bi bi-shield-check text-success me-1"></i>
                    SSL encrypted secure payment processing
                </small>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Stripe with CSRF-safe method
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();
    
    // Create an instance of the card Element
    const cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#424770',
                '::placeholder': {
                    color: '#aab7c4',
                },
            },
            invalid: {
                color: '#9e2146',
            },
        },
    });
    
    // Add an instance of the card Element into the `card-element` <div>
    cardElement.mount('#card-element');
    
    // Handle real-time validation errors from the card Element
    cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
            displayError.style.display = 'block';
        } else {
            displayError.textContent = '';
            displayError.style.display = 'none';
        }
    });
    
    const paymentMethodSelect = document.getElementById('id_payment_method');
    const cardFields = document.getElementById('cardPaymentFields');
    const form = document.querySelector('form');
    const submitButton = form.querySelector('button[type="submit"]');
    let isProcessingPayment = false;
    
    function toggleCardFields() {
        if (paymentMethodSelect.value === 'card') {
            cardFields.style.display = 'block';
        } else {
            cardFields.style.display = 'none';
        }
    }
    
    paymentMethodSelect.addEventListener('change', toggleCardFields);
    toggleCardFields(); // Initial check
    
    // Handle form submission
    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        if (isProcessingPayment) return; // Prevent double submission
        
        const paymentMethod = paymentMethodSelect.value;
        
        if (paymentMethod !== 'card') {
            // For non-card payments, submit normally
            form.submit();
            return;
        }
        
        // Handle Stripe card payment
        isProcessingPayment = true;
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
        
        try {
            // Create payment intent using API client
            const orderData = {
                order_id: {{ order.id }},
                amount: {{ order.total_amount }},
                currency: 'zar'
            };
            
            const intentResponse = await MarketHubAPI.createPaymentIntent(orderData);
            const data = intentResponse.data;
            
            if (!data.client_secret) {
                throw new Error(data.error || 'Failed to create payment intent');
            }
            
            // Create payment method first
            const {error: pmError, paymentMethod} = await stripe.createPaymentMethod({
                type: 'card',
                card: cardElement,
                billing_details: {
                    name: '{{ order.first_name }} {{ order.last_name }}',
                    email: '{{ order.email }}',
                },
            });
            
            if (pmError) {
                throw new Error(pmError.message);
            }
            
            // Confirm payment with Stripe
            const result = await stripe.confirmCardPayment(data.client_secret, {
                payment_method: paymentMethod.id
            });
            
            if (result.error) {
                // Show error to customer
                const errorElement = document.getElementById('card-errors');
                errorElement.textContent = result.error.message;
                errorElement.style.display = 'block';
                
                // Re-enable the submit button
                isProcessingPayment = false;
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="bi bi-lock-fill me-2"></i>Complete Payment';
            } else {
                // Payment succeeded
                if (result.paymentIntent.status === 'succeeded') {
                    // Save payment method if requested
                    const saveMethod = document.getElementById('save_payment_method').checked;
                    if (saveMethod) {
                        try {
                            await MarketHubAPI.savePaymentMethod(paymentMethod.id);
                        } catch (saveError) {
                            console.warn('Failed to save payment method:', saveError);
                        }
                    }
                    
                    // Show success message and redirect
                    submitButton.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Payment Successful!';
                    submitButton.className = 'btn btn-success btn-lg rounded-pill px-4';
                    
                    setTimeout(() => {
                        window.location.href = `/order-confirmation/${data.payment_intent_id || result.paymentIntent.id}/`;
                    }, 2000);
                }
            }
        } catch (error) {
            console.error('Payment error:', error);
            
            // Show error message
            const errorElement = document.getElementById('card-errors');
            errorElement.textContent = error.message || 'An unexpected error occurred. Please try again.';
            errorElement.style.display = 'block';
            
            // Re-enable the submit button
            isProcessingPayment = false;
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="bi bi-lock-fill me-2"></i>Complete Payment';
        }
    });
});
</script>

<style>
.icon-circle {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.form-control, .form-select {
    border-radius: 0.5rem;
    border: 1px solid #dee2e6;
    padding: 0.75rem 1rem;
}

.form-control:focus, .form-select:focus {
    border-color: #20c997;
    box-shadow: 0 0 0 0.2rem rgba(32, 201, 151, 0.25);
}
</style>
{% endblock %}
